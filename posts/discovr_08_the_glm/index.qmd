---
title: "discover_08 - General Linear Model"
author: "Colin Madland"
date: "2024-02-26"
categories: [regression, R, discovr]
editor: visual
image: "image.jpg"
---

```{r}
library(tidyverse, ggplot2)
album_tib <- here::here("data/album_sales.csv") |> readr::read_csv()
soc_anx_tib <- here::here("data/social_anxiety.csv") |> readr::read_csv()
metal_tib <- here::here("data/metal_health.csv")  |> readr::read_csv()
```

# Fitting the Linear Model

-   scatterplots to get an idea of whether assumption of linearity is met, look for outliers or other unusual cases
-   run an initial regression and save the diagnostics
-   if we want to generalize or test for significance or confidence intervals...
    -   examine residuals for homoscedasticity, independence, normality, and linearity
        -   lack of linearity --\> fit a non-linear model
        -   assumptions met and no bias --\> Model can be generalized
        -   lack of independent errors --\> multi-level model
        -   all other situations --\> fit a robust version of the model using bootstrapping (small samples) or robust standard errors

![General process of fitting a linear model from `discovr_08`](dsr2_fig_08_12_glm_process.png)

```{r}
album_tib
```

-   Use `GGally::ggscatmat` package to visualize the data
-   produces
    -   a matrix of scatterplots below the diagonal
    -   distributions along the diagonal
    -   the correlation coefficient above the diagonal

```{r}
GGally::ggscatmat(album_tib, columns = c("adverts", "airplay", "image", "sales"))  +
theme_minimal()
```

## Interpretation

-   3 predictors have reasonably linear relationships with album sales and no obvious outliers (except bottom left of 'band image' scatterplots)
-   across the diagonal (distributions)
    -   advertising is very skewed
    -   airplay and sales look heavy-tailed
-   correlations in the plot give us an idea of the relationships between predictors and outcome
-   if we ignore album sales, the highest correlation is between image ratings and amount of airplay, which is significant and the 0.01 level ($r=0.18$)
-   focussing on the outcome variable, adverts and airplay correlate best with the outcome ($r=0.58$ and $r=0.6$)

## One predictor

### Fitting the model

-   predicting sales from advertising alone

$$Y_i=b_0+{b_1}{X_i}+\epsilon_i$$

$$\text{Sales}_i=b_0+{b_1}{\text{Advertising}_i}+\epsilon_i$$

-   it is clear from the bottom left scatterplot and the correlation ($r=0.58$) that a positive relation exists. More advertising money spent leads to greater album sales.
-   some albums sell well regardless of advertising (top-left of scatterplot)
-   no albums sell badly when adverts are high (bottom-right of scatterplot)
-   to fit a linear model, we use `lm()` function `my_model <- lm(outcome ~ predictor(s), data = tibble, na.action = an action)`
    -   `my_model` is the name of the model
    -   `outcome` is the name of the outcome variable (sales)
    -   `predictor` is the name of the predictor variable (adverts) or, a list of variables separated by `+` symbols
    -   `tibble` is the name of the tibble containing the data (album_tib)
-   this function maps directly to the equation for the model
    -   `adverts ~ sales` maps to $\text{Sales}_i=b_0+{b_1}{\text{Advertising}_i}+\epsilon_i$ except we ignore the error term and parameter estimates and we replace the `=` with `~` (which means 'predicted from')

```{r}
album_lm <- lm(sales ~ adverts, data = album_tib, na.action = na.exclude)
summary(album_lm)
broom::glance(album_lm)  |> 
  knitr::kable(digits = 3)
```


- note $df=1$ and $df.residual=198$ therefore we can say that adding the predictor of advertising significantly improved the fit of the model to the data compared to having no predictors in the model
- $F(1,198)=99.59, p<.001$

### Model Parameters

To see model parameters, use `broom::tidy()`

`broom::tidy(model_name, conf.int = FALSE, conf.level = 0.95)`

- put the model name into the function, then two optional arguments
  - confidence intervals `conf.int=TRUE` (confidence intervals are not included by default)
  - default is 95%, but you can change it with `conf.level=.99` for 99% confidence interval

```{r}
broom::tidy(album_lm, conf.int = TRUE)
```

- output provides estimates of the model parameters ($\hat{b}$-values)
- $Y$ intercept ($b_0$) is 134.14 (when $X$ is 0, sales will be 134140)
- $X$ ($b_1$) is 0.096. 
  - represents the change in outcome associated with a unit change in predictor.
  - when the predictor increases by 1, the outcome increases by .096, but since the units of measurement was thousands of pounds and thousands of sales, an increase in $1000 will lead to 96 more albums sold
  - not very good return
  - BUT, we know that advertising only accounts for 1/3 of the variance
- If a predictor is having a significant impact on our ability to predict the outcome, then $\hat{b}$ should be different from 0 and large relative to its standard error
- the $t$-test (labelled statistic) and the associated $p$-value tell us whether the $\hat{b}$ is significantly different from 0
- the column p.value contains the exact probability that a value of $t$ at least as big as the one in the table would occur if the value of $b$ in the population were 0
- if this propbability is less than 0.05, then we interpret that as the predictor being a significant predictor of hte outcome.
- for both $t$s, the probabilities are in scientific notation 
  - `2.91e-19` means $2.91*10^{-19}$, or `move the decimal 19 places to the left` or `0.000000000000000000291`
  -  `2.91e+19` means $2.91*10^{19}$, or `move the decimal 19 places to the right` or `29100000000000000000`  
- both values are 0 at 3 decimal places
  
### Exploring the standard error of $\hat{b}$

https://www.youtube-nocookie.com/embed/3L9ZMdzJyyI?si=ET90VDYq3RVKnKDq

### Confidence intervals for $\hat{b}$

Imagine we collect 100 samples of data measuring the same variables as the current model, then estimate the same model, including confidence intervals for unstandardized values.The boundaries are constructed such that  95% of our 100 samples contain the population value of $b$. 95 of 100 sample will yield confidence intervals for $b$ that contain the population value, but we don't know if our sample is one of the 95.

We might just assume that it does, but if the confidence interval contains 0, then there is a possibility that there is no relationship, or the relationship might be negative. The trouble is that we would be wrong 5% of the time.

If the interval does not contain 0, we might conclude there is a genuine positive relationship.

### Using the model

$$\text{Sales}_i=\hat{b_0}+\hat{b_1}{\text{Advertising}_i}$$

$$\text{Sales}_i=134.14+.096*{Advertising}_i$$

Now we can make a prediction by entering a value for the advertising budget, say 100 (equal to 100,000 gbp)

$$\text{Sales}_i=134.14+.096*{100}_i$$

$$\text{Sales}_i=143.74$$
or 143,740 sales

## Several Predictors

add multiple predictors hierarchically, after advertising is shown to be significant

$$Y_i=b_0+{b_1}{X_1i}+{b_2}{X_2i}+{b_3}{X_3i}+ ... +{b_n}{X_ni}\epsilon_i$$

$$Y_i=b_0+{b_1}{advertising_i}+{b_2}{airplay_i}+{b_3}{image_i}+\epsilon_i$$

### Building the model

- add predictors to the R code the same way as we do in the equation, by adding `+`

```{r}
album_full_lm <- lm(sales ~ adverts + airplay + image, data = album_tib, na.action = na.exclude)
summary(album_full_lm)
broom::glance(album_full_lm)  |> 
  knitr::kable(digits = 3)
```